<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]),_paq.push(["setCookieDomain","*.ory.sh"]),_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//sqa-web.ory.sh/";_paq.push(["setTrackerUrl",e+"np.php"]),_paq.push(["setSiteId","2"]);var a=document,p=a.createElement("script"),t=a.getElementsByTagName("script")[0];p.type="text/javascript",p.async=!0,p.src=e+"js/np.min.js",t.parentNode.insertBefore(p,t)}()</script>
<link rel="search" type="application/opensearchdescription+xml" title="Ory Hydra" href="/hydra/docs/opensearch.xml"><title data-react-helmet="true">Hardware Security Module support for JSON Web Key Sets | Ory Hydra</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.ory.sh//hydra/docs/next/guides/hsm-support"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Hardware Security Module support for JSON Web Key Sets | Ory Hydra"><meta data-react-helmet="true" name="description" content="The"><meta data-react-helmet="true" property="og:description" content="The"><link data-react-helmet="true" rel="shortcut icon" href="/hydra/docs/img/favico.png"><link data-react-helmet="true" rel="canonical" href="https://www.ory.sh//hydra/docs/next/guides/hsm-support"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//hydra/docs/next/guides/hsm-support" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//hydra/docs/next/guides/hsm-support" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://V2EFIWEJ25-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/hydra/docs/assets/css/styles.9ac31348.css">
<link rel="preload" href="/hydra/docs/assets/js/runtime~main.fa0d89a0.js" as="script">
<link rel="preload" href="/hydra/docs/assets/js/main.0569656b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div id="route-identifier" data-route="/hydra/docs/next/guides/hsm-support"><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">Sign up for <a href="https://ory.us10.list-manage.com/subscribe?u=ffb1a878e4ec6c0ed312a3480&id=f605a41b53&group[17097][8]=1">important security announcements</a> and if you like Ory Hydra give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/ory/hydra">GitHub</a>!</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.ory.sh/hydra" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/hydra/docs/img/logo-hydra.svg" alt="Ory Hydra" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/hydra/docs/img/logo-hydra.svg" alt="Ory Hydra" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a href="https://www.ory.sh/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ory/hydra/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.ory.sh/chat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/ory/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/hydra/docs/next/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/hydra/docs/next/guides/hsm-support">Next</a></li><li><a class="dropdown__link" href="/hydra/docs/">v1.10</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.9/">v1.9</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.8/">v1.8</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.7/">v1.7</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.6/">v1.6</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.5/">v1.5</a></li><li><a class="dropdown__link" href="/hydra/docs/v1.4/">v1.4</a></li><li><a class="dropdown__link" href="/hydra/docs/versions">All versions</a></li></ul></div><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">üåú</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">üåû</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Welcome to Ory!<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/get-started" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Get started<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Ory Cloud</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Kratos</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Keto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Open Source Ory Hydra</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Implementing the User Interface</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Operations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/configure-deploy">Run Ory Hydra in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/dependencies-environment">Database Setup and Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/production">Preparing for Production</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/tracing">Distributed Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/hydra/docs/next/guides/hsm-support">Hardware Security Module support for JSON Web Key Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/secrets-key-rotation">Secrets and Key Rotation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/kubernetes-helm-chart">Kubernetes Helm Chart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/ssl-https-tls">SSL/TLS, HTTPS, Self-Signed Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/cookies">Configuring Cookies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/scaling-hydra">Scaling Ory Hydra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/cors">Setting up Cross-origin resource sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/gitlab">Gitlab Hydra integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/migrating-from-mitreid">Migrating from MITREid</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/guides/merge-multiple-db-secrets">Merge multiple system.secrets</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">OAuth2 &amp; OpenID Connect</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/hydra/docs/next/reference/api">HTTP API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Debug &amp; Help</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">SDKs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Development</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Further Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Oathkeeper</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Ory Hydra<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/hydra/docs/">latest version</a></b> (<!-- -->v1.10<!-- -->).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->Next</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Hardware Security Module support for JSON Web Key Sets</h1></header><p>The
<a href="http://docs.oasis-open.org/pkcs11/pkcs11-base/v2.40/os/pkcs11-base-v2.40-os.html" target="_blank" rel="noopener noreferrer">PKCS#11 Cryptographic Token Interface Standard</a>,
also known as Cryptoki, is one of the Public Key Cryptography Standards
developed by RSA Security. PKCS#11 defines the interface between an application
and a cryptographic device.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If a key is not found in the Hardware Security Module, the regular Software Key
Manager with AES-GCM software encryption will be used as a fallback. Storing
keys will always use the Software Key Manager as it is not possible to add keys
to a Hardware Security Module.</p></div></div><p>PKCS#11 is used as a low-level interface to perform cryptographic operations
without the need for the application to directly interface a device through its
driver. PKCS#11 represents cryptographic devices using a common model referred
to simply as a token. An application can therefore perform cryptographic
operations on any device or token, using the same independent command set.</p><a name="hsm-configuration"></a><h3 class="anchor anchorWithStickyNavbar_31ik" id="hardware-security-module-configuration">Hardware Security Module configuration<a aria-hidden="true" class="hash-link" href="#hardware-security-module-configuration" title="Direct link to heading">‚Äã</a></h3><p>Ory Hydra can be configured using environment variables as well as a
configuration file. For more information on configuration options, open the
configuration documentation:</p><p>&gt;<!-- -->&gt;<!-- --> <a href="https://www.ory.sh/hydra/docs/reference/configuration" target="_blank" rel="noopener noreferrer">https://www.ory.sh/hydra/docs/reference/configuration</a> <!-- -->&lt;<!-- -->&lt;</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">HSM_ENABLED=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_LIBRARY=/path/to/hsm-vendor/library.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_TOKEN_LABEL=hydra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_SLOT=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_PIN=1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Token that is denoted by environment variables <code>HSM_TOKEN_LABEL</code> or <code>HSM_SLOT</code>
must preexist and optionally contain RSA or ECDSA key pairs with labels
<code>hydra.openid.id-token</code> and <code>hydra.jwt.access-token</code> depending on configuration.
<strong><em>If keys with these labels don&#x27;t exist, they will be generated upon
startup.</em></strong> If both <code>HSM_TOKEN_LABEL</code> and <code>HSM_SLOT</code> are set, <code>HSM_TOKEN_LABEL</code>
takes preference over <code>HSM_SLOT</code>. In this case first slot that contains this
label is used. <code>HSM_LIBRARY</code> must point to vendor specific PKCS#11 library or
SoftHSM library if you want to <a href="#testing-with-softhsm">test HSM support</a>.</p><a name="pkcs11-attribute-mappings"></a><h3 class="anchor anchorWithStickyNavbar_31ik" id="pkcs11-attribute-mappings-to-json-web-key-set-attributes">PKCS#11 attribute mappings to JSON Web Key Set attributes<a aria-hidden="true" class="hash-link" href="#pkcs11-attribute-mappings-to-json-web-key-set-attributes" title="Direct link to heading">‚Äã</a></h3><p>When key pair is generated or requested from HSM, the <code>CKA_LABEL</code> attribute is
used as JSON Web Key Set name, <code>CKA_ID</code> attribute as <code>kid</code>. Key usage is
determined by private key attributes, where <code>CKA_SIGN</code> and <code>CKA_DECRYPT</code> are
mapped to <code>sig</code> and <code>enc</code> respectively and set as key <code>use</code> attribute.
Furthermore, <code>CKA_ID&#x27;s</code> of key pair private/public handles must be identical.
Attribute <code>alg</code> is determined from <code>CKA_KEY_TYPE</code> and <code>CKA_ECDSA_PARAMS</code>.</p><a name="supported-key-algorithms"></a><h3 class="anchor anchorWithStickyNavbar_31ik" id="supported-key-algorithms">Supported key algorithms<a aria-hidden="true" class="hash-link" href="#supported-key-algorithms" title="Direct link to heading">‚Äã</a></h3><p>Ory Hydra supports generating 4096 bit RSA, ECDSA keys with curves secp256r1 or
secp521r1. As of now PKCS#11 v2.4 doesn&#x27;t support EdDSA keys using curve
Ed25519. However,
<a href="https://docs.oasis-open.org/pkcs11/pkcs11-curr/v3.0/pkcs11-curr-v3.0.html" target="_blank" rel="noopener noreferrer">PKCS#11 v3.0</a>
contains support for EdDSA and therefore can be supported in upcoming versions.
Symmetric key algorithms are not supported because it would imply, that shared
HSM is used between server and authenticating client.</p><a name="generating-key-pairs"></a><h3 class="anchor anchorWithStickyNavbar_31ik" id="generating-key-pairs">Generating key pairs<a aria-hidden="true" class="hash-link" href="#generating-key-pairs" title="Direct link to heading">‚Äã</a></h3><a name="initializing-token"></a><h4 class="anchor anchorWithStickyNavbar_31ik" id="initializing-token">Initializing token<a aria-hidden="true" class="hash-link" href="#initializing-token" title="Direct link to heading">‚Äã</a></h4><p>Different policies can apply for tokens, therefore HSM configuration expects,
that token where to find or generate keys already exists. Depending on HSM
vendor, tools initializing tokens and generating keys vary. To demonstrate key
pair generation we first initialize token using <code>pkcs11-tool</code> (see how to
<a href="#testing-with-softhsm">setup SoftHSM and OpenSC</a>)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so --slot </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> --init-token --so-pin 0000 --pin </span><span class="token number" style="color:#36acaa">1234</span><span class="token plain"> --init-pin --label hydra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using slot </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> with a present token </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x2763db07</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Token successfully initialized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User PIN successfully initialized</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Corresponding Ory Hydra configuration to access this token would be</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">HSM_ENABLED=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_LIBRARY=/usr/lib/softhsm/libsofthsm2.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_TOKEN_LABEL=hydra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_SLOT=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HSM_PIN=1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><a name="generating-key-pair"></a><h4 class="anchor anchorWithStickyNavbar_31ik" id="generating-key-pair">Generating key pair<a aria-hidden="true" class="hash-link" href="#generating-key-pair" title="Direct link to heading">‚Äã</a></h4><p>Generating RSA keypair for JSON Web Key <code>hydra.openid.id-token</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--pin </span><span class="token number" style="color:#36acaa">1234</span><span class="token plain"> --token-label hydra </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--keypairgen --key-type rsa:4096 --usage-sign </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--label hydra.openid.id-token --id 746573742d6b65792d6964</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key pair generated:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Private Key Object</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> RSA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  label:      hydra.openid.id-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ID:         746573742d6b65792d6964</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:      sign</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Public Key Object</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> RSA </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  label:      hydra.openid.id-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ID:         746573742d6b65792d6964</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:      verify</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><table><thead><tr><th align="left">Parameter</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>--module</code></td><td align="left">Points to vendor specific PKCS#11 library or SoftHSM library when testing.</td></tr><tr><td align="left"><code>--pin 1234</code></td><td align="left">Pin that was used in token initialization to perform token operations.</td></tr><tr><td align="left"><code>--token-label hydra</code></td><td align="left">Performs key generation on first slot with label <code>hydra</code>. Use <code>--slot</code> option instead if you want to specify specific slot.</td></tr><tr><td align="left"><code>--label hydra.openid.id-token</code></td><td align="left">Sets key pair label attribute <code>CKA_LABEL</code> and is used as JSON Web Key Set name.</td></tr><tr><td align="left"><code>--id 746573742d6b65792d6964</code></td><td align="left">Sets key pair id attribute <code>CKA_ID</code> and is used as JSON Web Key Set <code>kid</code>. It must be set as a big-endian hexadecimal integer value. <code>StringToHex(&quot;test-key-id&quot;) == 746573742d6b65792d6964</code></td></tr><tr><td align="left"><code>--keypairgen</code></td><td align="left">Perform key pair generation on token</td></tr><tr><td align="left"><code>--key-type rsa:4096</code></td><td align="left">Type and length of the key to generate. Supported values are <code>rsa:4096</code>, <code>EC:secp256r1</code> or <code>EC:secp521r1</code>. Sets <code>CKA_KEY_TYPE</code>,<code>CKA_ECDSA_PARAMS</code> attributes and is used to determine JSON Web Key Set <code>alg</code> attribute.</td></tr><tr><td align="left"><code>--usage-sign</code> or <code>--usage-decrypt</code></td><td align="left">Sets private key attribute <code>CKA_SIGN</code> or <code>CKA_DECRYPT</code> respectively. Used to determine JSON Web Key Set <code>use</code> attribute.</td></tr></tbody></table><a name="key-type-mappings"></a><h5 class="anchor anchorWithStickyNavbar_31ik" id="key-type-mappings">Key type mappings<a aria-hidden="true" class="hash-link" href="#key-type-mappings" title="Direct link to heading">‚Äã</a></h5><table><thead><tr><th align="left">Key type</th><th align="left">JWT signing algorithm</th></tr></thead><tbody><tr><td align="left">rsa:4096</td><td align="left">RS256</td></tr><tr><td align="left">EC:secp256r1</td><td align="left">ES256</td></tr><tr><td align="left">EC:secp521r1</td><td align="left">ES512</td></tr></tbody></table><a name="testing-with-softhsm"></a><h3 class="anchor anchorWithStickyNavbar_31ik" id="testing-with-softhsm">Testing with SoftHSM<a aria-hidden="true" class="hash-link" href="#testing-with-softhsm" title="Direct link to heading">‚Äã</a></h3><p><a href="https://www.opendnssec.org/softhsm/" target="_blank" rel="noopener noreferrer">SoftHSM</a> is an implementation of a
cryptographic store accessible through a PKCS #11 interface. You can use it to
explore PKCS#11 without having a Hardware Security Module. It is being developed
as a part of the OpenDNSSEC project.</p><p><a href="https://wiki.opendnssec.org/display/SoftHSMDOCS/SoftHSM+Documentation+v2" target="_blank" rel="noopener noreferrer">Follow these instructions to build SoftHSM from source.</a></p><h4 class="anchor anchorWithStickyNavbar_31ik" id="install-softhsmopensc-on-mac-osx">Install SoftHSM/OpenSC on Mac OSX<a aria-hidden="true" class="hash-link" href="#install-softhsmopensc-on-mac-osx" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ruby -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">curl</span><span class="token string variable" style="color:#36acaa"> -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> softhsm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ruby -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">curl</span><span class="token string variable" style="color:#36acaa"> -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> opensc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_31ik" id="install-softhsmopensc-on-ubuntu">Install SoftHSM/OpenSC on Ubuntu<a aria-hidden="true" class="hash-link" href="#install-softhsmopensc-on-ubuntu" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> softhsm opensc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_31ik" id="install-softhsmopensc-on-windows">Install SoftHSM/OpenSC on Windows<a aria-hidden="true" class="hash-link" href="#install-softhsmopensc-on-windows" title="Direct link to heading">‚Äã</a></h4><p>Follow these instructions to install
<a href="https://github.com/disig/SoftHSM2-for-Windows" target="_blank" rel="noopener noreferrer">SoftHSM</a> and
<a href="https://github.com/OpenSC/OpenSC/wiki" target="_blank" rel="noopener noreferrer">OpenSC</a> on windows.</p><h4 class="anchor anchorWithStickyNavbar_31ik" id="run-ory-hydra-with-hsm-using-docker">Run Ory Hydra with HSM using Docker<a aria-hidden="true" class="hash-link" href="#run-ory-hydra-with-hsm-using-docker" title="Direct link to heading">‚Äã</a></h4><p>Alternatively you can use quickstart docker container that setups
SoftHSM/OpenSC, builds and runs Ory Hydra with HSM configuration enabled. You
need to have the latest <a href="https://www.docker.com" target="_blank" rel="noopener noreferrer">Docker</a> and
<a href="https://docs.docker.com/compose" target="_blank" rel="noopener noreferrer">Docker Compose</a> version installed. To run
quickstart HSM change into the directory with the Hydra source code and run the
following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose -f quickstart-hsm.yml up --build</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Following is logged on startup if Hardware Security Module is successfully
configured:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker logs ory-hydra-example--hydra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2021-07-07T12:51:23Z&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">level</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">info </span><span class="token assign-left variable" style="color:#36acaa">msg</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Hardware Security Module is configured.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2021-07-07T12:51:23Z&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">level</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">info </span><span class="token assign-left variable" style="color:#36acaa">msg</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;JSON Web Key Set &#x27;hydra.openid.id-token&#x27; does not exist yet, generating new key pair...&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_31ik" id="run-tests-with-hsm-enabled-using-docker">Run Tests with HSM enabled using Docker<a aria-hidden="true" class="hash-link" href="#run-tests-with-hsm-enabled-using-docker" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> quicktest-hsm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ory/hydra/edit/master/docs/docs/guides/hsm-support.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-01-11T15:33:22.000Z">1/11/2022</time></b> by <b>Mart Aarma</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/hydra/docs/next/guides/tracing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Distributed Tracing</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/hydra/docs/next/guides/secrets-key-rotation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Secrets and Key Rotation<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#hardware-security-module-configuration" class="table-of-contents__link toc-highlight">Hardware Security Module configuration</a></li><li><a href="#pkcs11-attribute-mappings-to-json-web-key-set-attributes" class="table-of-contents__link toc-highlight">PKCS#11 attribute mappings to JSON Web Key Set attributes</a></li><li><a href="#supported-key-algorithms" class="table-of-contents__link toc-highlight">Supported key algorithms</a></li><li><a href="#generating-key-pairs" class="table-of-contents__link toc-highlight">Generating key pairs</a></li><li><a href="#testing-with-softhsm" class="table-of-contents__link toc-highlight">Testing with SoftHSM</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.ory.sh/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.ory.sh/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://www.ory.sh/tos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div>Copyright ¬© 2022 ORY GmbH</div></div></div></footer></div></div>
<script src="/hydra/docs/assets/js/runtime~main.fa0d89a0.js"></script>
<script src="/hydra/docs/assets/js/main.0569656b.js"></script>
<script src="https://www.ory.sh/scripts.js" async></script>
<noscript><p><img src="//sqa-web.ory.sh/np.php?idsite=2&amp;rec=1" style="border:0;" alt=""></p></noscript></body>
</html>